name: Issue Triage

permissions: read-all

on:
  issues:
    types:
      [opened, reopened, edited, labeled, unlabeled, milestoned, demilestoned]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Triage issue
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            if (context.payload.issue.pull_request) {
              console.log('Skipping pull request');
              return;
            }

            // ------------------------------------------------------
            // Vars
            // ------------------------------------------------------

            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const hasMilestone = !!issue.milestone;
            const currentLabels = issue.labels.map(label => label.name);

            // ------------------------------------------------------
            // Helper Functions
            // ------------------------------------------------------

            const hasLabelStartingWith = (prefix) => {
              return currentLabels.some(label => label.startsWith(prefix));
            };

            const getLabelsStartingWith = (prefix) => {
              return currentLabels.filter(label => label.startsWith(prefix));
            };

            // ------------------------------------------------------
            // Setup
            // ------------------------------------------------------

            console.log(`Processing issue #${issueNumber}`);
            console.log(`Has milestone: ${hasMilestone}`);
            console.log(`Current labels: ${currentLabels.join(', ')}`);

            // ------------------------------------------------------
            // Check for declined issues
            // ------------------------------------------------------

            if (currentLabels.includes('triage/declined')) {
              console.log('Issue is labeled triage/declined: closing.');

              // Remove other conflicting triage labels
              const otherTriageLabels = currentLabels.filter(l =>
                l.startsWith('triage/') && l !== 'triage/declined'
              );
              for (const label of otherTriageLabels) {
                console.log(`Removing conflicting label: ${label}`);
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: label
                  });
                } catch (error) {
                  if (error.status === 404) {
                    console.log(`Label ${label} not found (may have been already removed)`);
                  } else {
                    throw error;
                  }
                }
              }

              // Clean up milestone if present
              if (hasMilestone) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  milestone: null
                });
                console.log('Milestone removed');
              }

              // close the issue if not already closed
              if (issue.state !== 'closed') {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
                console.log('Issue closed');
              } else {
                console.log('Issue already closed');
              }

              return;
            }

            // ------------------------------------------------------
            // Apply Rules
            //
            // 1. If an issue has no milestone:
            //    a. Ensure it has the label 'triage/needs-triage'
            //       (unless it already has a different triage label).
            //    b. Remove 'triage/accepted' if present.
            //
            // 2. If an issue has a milestone:
            //    a. Ensure it has the label 'triage/accepted' and
            //       no other triage labels.
            //
            // 3. If another triage label is added, remove the
            //    'triage/needs-triage' label.
            //
            // ------------------------------------------------------

            const labelsToAdd = [];
            const labelsToRemove = [];

            if (!hasMilestone) {
              // remove 'triage/accepted' when there's no milestone (e.g., milestone was removed)
              if (currentLabels.includes('triage/accepted')) {
                labelsToRemove.push('triage/accepted');
                console.log('No milestone -> removing triage/accepted');
              }

              // ensure 'triage/needs-triage' label (only if no other triage label exists)
              // note: we need to account for triage/accepted being removed above
              const remainingTriageLabels = currentLabels.filter(l =>
                l.startsWith('triage/') &&
                l !== 'triage/accepted' &&
                !labelsToRemove.includes(l)
              );

              if (remainingTriageLabels.length === 0) {
                labelsToAdd.push('triage/needs-triage');
                console.log('No milestone and no triage label -> adding triage/needs-triage');
              } else if (currentLabels.includes('triage/needs-triage')) {
                // if another triage label exists, remove 'triage/needs-triage'
                labelsToRemove.push('triage/needs-triage');
                console.log('Other triage label found -> removing triage/needs-triage');
              }

            } else {
              // ensure 'triage/accepted' and remove other triage labels
              const triageLabels = getLabelsStartingWith('triage/');
              if (!triageLabels.includes('triage/accepted')) {
                labelsToAdd.push('triage/accepted');
                console.log('Has milestone but missing triage/accepted -> adding it');
              }

              // remove all other triage labels
              triageLabels.forEach(label => {
                if (label !== 'triage/accepted') {
                  labelsToRemove.push(label);
                  console.log(`Has milestone -> removing ${label}`);
                }
              });
            }

            // ------------------------------------------------------
            // Apply Changes
            // ------------------------------------------------------

            if (labelsToAdd.length > 0) {
              console.log(`Adding labels: ${labelsToAdd.join(', ')}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labelsToAdd
              });
            }

            for (const label of labelsToRemove) {
              console.log(`Removing label: ${label}`);
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: label
                });
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Label ${label} not found (may have been already removed)`);
                } else {
                  throw error;
                }
              }
            }

            if (labelsToAdd.length === 0 && labelsToRemove.length === 0) {
              console.log('No label changes needed');
            }
